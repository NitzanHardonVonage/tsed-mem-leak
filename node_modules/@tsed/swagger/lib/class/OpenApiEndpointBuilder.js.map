{"version":3,"file":"OpenApiEndpointBuilder.js","sourceRoot":"","sources":["../../src/class/OpenApiEndpointBuilder.ts"],"names":[],"mappings":"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","sourcesContent":["import {EndpointMetadata, PathParamsType} from \"@tsed/common\";\nimport {deepClone, deepExtends, isArrayOrArrayClass, isPromise, Store} from \"@tsed/core\";\nimport {Operation, Path, Response} from \"swagger-schema-official\";\nimport {OpenApiResponses} from \"../interfaces/OpenApiResponses\";\nimport {parseSwaggerPath} from \"../utils\";\nimport {OpenApiModelSchemaBuilder} from \"./OpenApiModelSchemaBuilder\";\nimport {OpenApiParamsBuilder} from \"./OpenApiParamsBuilder\";\n\n/** */\n\nexport class OpenApiEndpointBuilder extends OpenApiModelSchemaBuilder {\n  private _paths: {[pathName: string]: Path} = {};\n\n  constructor(\n    private endpoint: EndpointMetadata,\n    private endpointUrl: string,\n    private pathMethod: {path?: PathParamsType; method?: string},\n    private getOperationId: (targetName: string, methodName: string) => string\n  ) {\n    super(endpoint.target);\n  }\n\n  /**\n   *\n   * @returns {}\n   */\n  public get paths(): {[p: string]: Path} {\n    return this._paths;\n  }\n\n  /**\n   *\n   * @returns {this}\n   */\n  build(): this {\n    parseSwaggerPath(this.endpointUrl, this.pathMethod.path).forEach(({path: endpointPath, pathParams}) => {\n      const builder = new OpenApiParamsBuilder(this.endpoint.target, String(this.endpoint.propertyKey), pathParams).build();\n\n      const path: any = this._paths[endpointPath] || {};\n\n      path[this.pathMethod.method!] = this.createOperation(builder);\n\n      Object.assign(this._definitions, builder.definitions);\n\n      this._paths[endpointPath] = path;\n    });\n\n    return this;\n  }\n\n  /**\n   *\n   * @param {OpenApiResponses} builderResponses\n   * @returns {OpenApiResponses}\n   */\n  private createResponses(builderResponses: OpenApiResponses): OpenApiResponses {\n    const responses = this.endpoint.get(\"responses\") || {};\n\n    deepExtends(responses, builderResponses);\n\n    responses[String(this.endpoint.statusCode)] = {description: \"Success\"};\n\n    Object.keys(responses).forEach(code => {\n      responses[code] = this.createResponse(code, responses[code]);\n    });\n\n    return responses;\n  }\n\n  /**\n   *\n   * @returns {Operation}\n   * @param builder\n   */\n  private createOperation(builder: OpenApiParamsBuilder): Operation {\n    const operationId = this.getOperationId(this.endpoint.targetName, String(this.endpoint.propertyKey));\n    const security = this.endpoint.get(\"security\");\n    const produces = this.endpoint.get(\"produces\");\n    const consumes = this.endpoint.get(\"consumes\");\n\n    return deepExtends(\n      {\n        operationId,\n        tags: [this.getTagName()],\n        parameters: builder.parameters.length ? builder.parameters : undefined,\n        consumes,\n        responses: this.createResponses(builder.responses),\n        security,\n        produces\n      },\n      this.endpoint.get(\"operation\") || {}\n    );\n  }\n\n  /**\n   *\n   * @returns {string}\n   */\n  private getTagName(): string {\n    const clazz = this.endpoint.target;\n    const ctrlStore = Store.from(clazz);\n    const tag = ctrlStore.get(\"tag\");\n    const name = ctrlStore.get(\"name\");\n\n    return name || (tag && tag.name) || this.endpoint.targetName;\n  }\n\n  /**\n   *\n   * @param {string | number} code\n   * @param options\n   * @returns {Response}\n   */\n  private createResponse(code: string | number, options: Response): Response {\n    const {type, collectionType, code: _, headers, ...obj} = deepExtends(options, this.endpoint.statusResponse(code) || {});\n    const response = deepClone(obj);\n\n    if (type) {\n      response.schema = this.createSchema({\n        schema: this.endpoint.get(\"schema\"),\n        type: isPromise(type) || isArrayOrArrayClass(type) || type === Object ? undefined! : type,\n        collectionType\n      });\n    }\n\n    if (headers) {\n      response.headers = Object.entries(headers).reduce((obj, [key, {value, ...schema}]: any[]) => {\n        return {\n          ...obj,\n          [key]: {\n            ...schema\n          }\n        };\n      }, {});\n    }\n\n    return response;\n  }\n}\n"]}