"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const core_1 = require("@tsed/core");
const mvc_1 = require("../../mvc");
const uuidv4 = require("uuid/v4");
/**
 * Bind request and create a new context to store information during the request lifecycle. See @@RequestContext@@ for more details.
 *
 * @param injector
 */
function contextMiddleware(injector) {
    const { ignoreUrlPatterns = [], reqIdBuilder = (() => uuidv4().replace(/-/gi, "")) } = injector.settings.logger || {};
    return (request, response, next) => tslib_1.__awaiter(this, void 0, void 0, function* () {
        const id = reqIdBuilder();
        request.ctx = new mvc_1.RequestContext({
            id,
            logger: injector.logger,
            url: request.originalUrl || request.url,
            ignoreUrlPatterns
        });
        request.id = id;
        request.log = request.ctx.logger;
        core_1.applyBefore(response, "end", () => tslib_1.__awaiter(this, void 0, void 0, function* () {
            yield injector.emit("$onResponse", request, response);
            yield request.ctx.destroy();
        }));
        yield injector.emit("$onRequest", request, response);
        next();
    });
}
exports.contextMiddleware = contextMiddleware;
//# sourceMappingURL=contextMiddleware.js.map